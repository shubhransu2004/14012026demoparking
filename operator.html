<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>FeeParking | Operator Panel</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        :root { --bg: #0a0a0c; --card: #16161a; --accent: #10b981; --text: #f4f4f5; }
        body { background: var(--bg); color: var(--text); font-family: system-ui; margin: 0; padding: 20px; }
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; }
        .slot-card { background: var(--card); padding: 20px; border-radius: 12px; border: 1px solid #27272a; text-align: center; }
        .occ { border-top: 4px solid #ef4444; }
        .free { border-top: 4px solid var(--accent); }
        .plate { font-family: monospace; font-size: 1.2rem; font-weight: bold; margin: 10px 0; }
        .log-list { margin-top: 30px; background: var(--card); border-radius: 12px; padding: 10px; }
        .log-item { padding: 10px; border-bottom: 1px solid #27272a; display: flex; justify-content: space-between; font-size: 0.9rem; }
    </style>
</head>
<body>
    <h2>Live Floor Occupancy</h2>
    <div id="slot-grid" class="grid"></div>

    <div class="log-list">
        <h3>Recent Activity</h3>
        <div id="activity-log"></div>
    </div>

    <script>
        const SB_URL = "https://vlxyoxuejydfpclhxczr.supabase.co/rest/v1/Slots";
        const SB_KEY = "sb_publishable_X8F1t9Qs_bznY7OrJtp0Ew_wQDe_7qV";

        async function refreshData() {
            try {
                const r = await fetch(`${SB_URL}?select=*`, {
                    headers: { "apikey": SB_KEY, "Authorization": `Bearer ${SB_KEY}` }
                });
                const data = await r.json();
                render(data);
            } catch (e) { console.error("Update failed", e); }
        }

        function render(slots) {
            const grid = document.getElementById("slot-grid");
            const log = document.getElementById("activity-log");
            
            grid.innerHTML = slots.map(s => `
                <div class="slot-card ${s.current_occupancy ? 'occ' : 'free'}">
                    <div style="font-size: 0.8rem; opacity: 0.6;">${s.name}</div>
                    <div class="plate">${s.metadata?.last_plate || '---'}</div>
                    <div style="font-size: 0.7rem;">${s.current_occupancy ? 'OCCUPIED' : 'VACANT'}</div>
                </div>
            `).join('');

            // Filter for slots that have plate data in metadata
            const recent = slots.filter(s => s.metadata?.last_plate).sort((a,b) => b.updated_at.localeCompare(a.updated_at));
            log.innerHTML = recent.map(r => `
                <div class="log-item">
                    <span><strong>${r.metadata.last_plate}</strong></span>
                    <span style="color: ${r.metadata.direction === 'ENTRY' ? '#10b981' : '#ef4444'}">${r.metadata.direction}</span>
                    <span style="opacity: 0.5;">${new Date(r.updated_at).toLocaleTimeString()}</span>
                </div>
            `).join('');
        }

        setInterval(refreshData, 3000);
        refreshData();
    </script>
</body>
</html>
